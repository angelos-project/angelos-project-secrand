version: 2.1

orbs:
  coverage-reporter: codacy/coverage-reporter@14.1.0


executors:
  gradle:
    docker:
      - image: cimg/android:2026.02-browsers
    resource_class: medium

commands:
  extract_m2_version:
    steps:
      - run:
          name: Extract LocalRepo name
          command: |
            echo "m2-v1" > /tmp/m2-cache-key.txt
  extract_gradle_version:
    steps:
      - run:
          name: Extract Gradle version
          command: |
            GRADLE_VERSION=$(grep -o 'gradle-[0-9.]*' gradle/wrapper/gradle-wrapper.properties | cut -d- -f2)
            echo "$GRADLE_VERSION" > /tmp/gradle-cache-key.txt
  extract_kotlin_version:
    steps:
      - run:
          name: Extract Kotlin version
          command: |
            KOTLIN_VERSION=$(grep 'kotlin =' gradle/libs.versions.toml | cut -d'"' -f2)
            echo "$KOTLIN_VERSION" > /tmp/kotlin-cache-key.txt
  restore_gradle_cache:
    steps:
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "/tmp/gradle-cache-key.txt" }}
            - gradle-v1-
  restore_konan_cache:
    steps:
      - restore_cache:
          keys:
            - konan-v1-{{ checksum "/tmp/kotlin-cache-key.txt" }}
            - konan-v1-
  restore_m2_cache:
    steps:
      - restore_cache:
          keys:
            - m2-v1-{{ checksum "/tmp/m2-cache-key.txt" }}
            - m2-v1-
  ensure_gradle_wrapper:
    steps:
      - run:
          name: Ensure Gradle Wrapper JAR
          command: |
            mkdir -p gradle/wrapper
            if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
              GRADLE_VERSION=$(sed -n 's/.*gradle-\(.*\)-bin\.zip.*/\1/p' gradle/wrapper/gradle-wrapper.properties)
              curl -L --fail --silent -o gradle/wrapper/gradle-wrapper.jar \
                "https://raw.githubusercontent.com/gradle/gradle/v${GRADLE_VERSION}/gradle/wrapper/gradle-wrapper.jar"
            fi
  accept_android_licenses:
    steps:
      - run:
          name: Accept Android licenses
          command: yes | sdkmanager --licenses || true
  configure_kotlin_native:
    steps:
      - run:
          name: Configure Kotlin Native
          command: echo "kotlin.native.ignoreDisabledTargets=true" >> gradle.properties
  run_tests:
    steps:
      - run:
          name: Run allTests
          command: ./gradlew allTests --no-daemon --stacktrace
  publish_to_maven_local:
    steps:
      - run:
          name: Publish to Maven Local
          command: ./gradlew publishToMavenLocal --no-daemon --stacktrace
  collect_test_results:
    steps:
      - run:
          name: Collect test results
          command: |
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
  codacy_kover_report:
    steps:
    - run:
        name: Generate Kover XML report for Codacy
        command: ./gradlew koverXmlReport --no-daemon
  save_gradle_cache:
    steps:
      - save_cache:
          key: gradle-v1-{{ checksum "/tmp/gradle-cache-key.txt" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
  save_konan_cache:
    steps:
      - save_cache:
          key: konan-v1-{{ checksum "/tmp/kotlin-cache-key.txt" }}
          paths:
            - ~/.konan
  save_m2_cache:
    steps:
      - save_cache:
          key: m2-v1-{{ checksum "/tmp/m2-cache-key.txt" }}
          paths:
            - ~/.m2
  prepare:
    steps:
      - checkout
      - extract_gradle_version
      - extract_kotlin_version
      - extract_m2_version
      - restore_gradle_cache
      - restore_konan_cache
      - restore_m2_cache
      - ensure_gradle_wrapper
      - accept_android_licenses
      - configure_kotlin_native
  cleanup:
    steps:
      - save_gradle_cache
      - save_konan_cache
      - save_m2_cache

jobs:
  codacy-coverage-report:
    executor: gradle
    environment:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.jvmargs=-Xmx4g"
    steps:
      - prepare
      - codacy_kover_report
      - coverage-reporter/send_report:
          coverage-reports: library/build/reports/kover/report.xml -l Kotlin final
          project-token: $CODACY_PROJECT_TOKEN
      - cleanup
  build-test-and-publish-local:
    executor: gradle
    environment:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.jvmargs=-Xmx4g"
    steps:
      - prepare
      - run_tests
      - publish_to_maven_local
      - collect_test_results
      - store_test_results:
          path: ~/test-results
      - store_artifacts:
          path: build/reports
          destination: test-reports
      - persist_to_workspace:
          root: .
          paths:
            - build/
            - .gradle/
      - cleanup

workflows:
  version: 2
  ci:
    jobs:
      - codacy-coverage-report